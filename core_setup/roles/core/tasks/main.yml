# Created by jacob.mendt@pikobytes.de on 13.10.21
#
# This file is subject to the terms and conditions defined in file
# "LICENSE", which is part of this source code package
#
# Basic configuration of the core system
#  * Installof basic dependencies
#  * Add new ssh user and block root user for ssh
#  * Set iptables
---
  - name: Upgrade all packages to latest version (dist-upgrade)
    apt:
      upgrade: dist
      update_cache: yes
    become: yes

  - name: Install basic admin tools
    apt:
      name: [vim, sudo, mc, git]
    become: yes

  #
  # Create custom user and allow only him to acces via ssh
  #
  - name: "Create user {{ custom_remote_user }}"
    user:
      name: "{{ custom_remote_user }}"
      groups: sudo
      append: yes
      shell: /bin/bash

  - name: Copy authorized_keys
    shell: "cp -r /root/.ssh /home/{{ custom_remote_user }}"

  - name: Set correct ownership for password directory
    shell: "chown -R {{ custom_remote_user }}:{{ custom_remote_user }} /home/{{ custom_remote_user }}/.ssh"

  - name: Replace sudoers
    copy:
      src: ./files/sudoers
      dest: /etc/sudoers
      owner: root
      group: root
      mode: "u=r,g=r"

  - name: Replace sshd_config
    template:
      src: sshd_config.j2
      dest: /etc/ssh/sshd_config
      owner: root
      group: root
      mode: "u=rw,g=r,o=r"

  - name: Restart ssh service
    shell: /etc/init.d/ssh restart

  - include_tasks: iptables-basic.yml